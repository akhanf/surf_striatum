#!/bin/bash


function usage {
 echo ""
 echo "Usage: ${0##*/}  <working dir>  <subjid/list> <options>"
 echo "" 
 
}

if [ "$#" -lt 2 ]
then
 usage
 exit 1
fi

#look for atlases in <scripts_dir>/atlases
execpath=`dirname $0`
execpath=`realpath $execpath`

work_dir=$1
shift 1



#this script computes diffusion-based parcellation and corresponding volume 


#requires c3d

parcellate=striatum

. $execpath/${parcellate}.cfg



pushd $work_dir

# NEED TO FIX: should use paths defined in config file, or compute on the fly from existing atlas
hemi_nii=$atlas/labels/t1/striatum_penny/hemi.nii.gz
#mask=$atlas/labels/t1/striatum/striatum-structural-1mm.nii.gz

for subj in $@
do
 
if [ "$legacy_dwi_proc" = 1 ]
then
track_dir=$subj_dir/$legacy_dwi_path/bedpost.${parcellation_name}/probtrack
else
track_dir=$subj_dir/bedpost.${parcellation_name}/probtrack
fi

 
 #use same template-based mask to define outer boundaries of striatum (to ensure these are identical for both diffusion and template-based maps)



 dti_parc=$track_dir/diffusion_parcellation.masked.nii.gz

# if [ ! -e $dti_parc ]
 #then 


 seedlist=""
for lbl_line in `cat $target_labels_txt`
do

  lbl=${lbl_line%%,*}
 
  map=$track_dir/seeds_to_$lbl.nii.gz

  for hemi in left right
  do

  
   hemi_map=$track_dir/seeds_to_$lbl.mask_$hemi.nii.gz

   if [ "$hemi" = "left" ]
   then
      fslmaths $hemi_nii -uthr 1 -thr 1 -bin -mul $map $hemi_map
   else
      fslmaths $hemi_nii -uthr 2 -thr 2 -bin -mul $map $hemi_map
   fi



   seedlist="$seedlist $track_dir/seeds_to_${lbl}.mask_${hemi}.nii.gz"
  done


done


 


 #create map for diffusion-based parcellation 
echo fslmerge -t $track_dir/seeds.4d.nii.gz $seedlist
 fslmerge -t $track_dir/seeds.4d.nii.gz $seedlist
echo  prob4DtoMaxProb $track_dir/seeds.4d.nii.gz 1 $dti_parc
 prob4DtoMaxProb $track_dir/seeds.4d.nii.gz 1 $dti_parc

#REMOVED FINAL MASKING
#echo  fslmaths $mask -bin -mul $dti_parc $dti_parc
# fslmaths $mask -bin -mul $dti_parc $dti_parc

# fi




done

popd

exit 0
