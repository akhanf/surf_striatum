#!/bin/bash

function usage {
 echo ""
 echo "Usage: ${0##*/}  <working dir>  <subjids..> <options>"
 echo "" 
 
}

if [ "$#" -lt 2 ]
then
 usage
 exit 1
fi

execpath=`dirname $0`
execpath=`realpath $execpath`
. $execpath/000_global_settings.cfg


work_dir=$1
shift 1


interp_opt="-LIN"

. $parcellate_cfg


pushd $work_dir

for subj in $@
do



#warp probtrack seed to target files back to MNI
#then average and create maxprob parcellation


 subj_dir=$subj
 
 reg_dir=$subj_dir/reg/bspline_f3d_t1/${atlas}_${subj}


#apply xfm (using linear interp) 
cpp=$reg_dir/ctrlpt_${subj}_to_${atlas}.nii.gz
coreg_dir=$subj_dir/coreg/rigid_aladin_t1_$legacy_dwi_type
execpath=`realpath $execpath`

xfm_dwi_t1=$coreg_dir/${legacy_dwi_type}_to_t1.xfm

if [ "$legacy_dwi_proc" = 1 ]
then
track_dir=$subj_dir/$legacy_dwi_path/bedpost.${parcellation_name}/probtrack
else
track_dir=$subj_dir/bedpost.${parcellation_name}/probtrack
fi


out_dir=$track_dir/$atlas
mkdir -p $out_dir

subj_t1=$subj_dir/t1/t1.brain.nii.gz
atlas_t1=${atlas}/t1/t1.brain.nii.gz


for track in `ls $track_dir/seeds_to_*.nii.gz`
do

target=${track##*seeds_to_}
target=${target%%.nii.gz}

track_atlas=$out_dir/seeds_to_${target}.nii.gz
if [ "$legacy_dwi_proc" = 1 ]
then
reg_resample -flo $track -res $track_atlas -aff $xfm_dwi_t1 -ref $subj_t1 -LIN
reg_resample -flo $track_atlas -res $track_atlas -cpp $cpp -ref $atlas_t1 -LIN
else
reg_resample -flo $track -res $track_atlas -cpp $cpp -ref $atlas_t1 -LIN
fi

done





done

popd
exit 0
